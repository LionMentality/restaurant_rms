{% extends "base.html" %}
{% block content %}
  <h1 class="page-title">Staff Management</h1>
  <p class="page-sub">Manage your staff members and approve/reject requests</p>

  <div class="card pad" style="margin-top:16px;">
    <div style="font-weight:900;font-size:18px;">My Staff</div>
    <div class="page-sub">Staff members assigned to you</div>

    {% if staff_rows|length == 0 %}
      <div class="page-sub" style="margin-top:12px;">No staff assigned.</div>
    {% else %}
      <div style="margin-top:14px;display:flex;flex-direction:column;gap:12px;">
        {% for s in staff_rows %}
          <div class="row">
            <div style="flex:1;">
              <div class="row-title">{{ s.first_name }} {{ s.last_name }}</div>
              <div class="row-sub">{{ s.role or "‚Äî" }} ‚Ä¢ {{ s.email or "‚Äî" }}</div>
              <div class="row-sub">{{ s.phone_number or "‚Äî" }} ‚Ä¢ {{ s.address }}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              {% if s.is_active %}
                <span class="badge dark">Active</span>
              {% else %}
                <span class="badge gray">Inactive</span>
              {% endif %}
              <button
                class="btn gray"
                style="padding:6px 12px;font-size:13px;"
                onclick="confirmDeleteStaff({{ s.staff_id }}, '{{ s.first_name }} {{ s.last_name }}')">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="card pad" style="margin-top:16px;">
    <div style="font-weight:900;font-size:18px;">Requests</div>
    <div class="page-sub">Time off / availability / overtime requests</div>

    {% if req_rows|length == 0 %}
      <div class="page-sub" style="margin-top:12px;">No requests yet.</div>
    {% else %}
      <div style="margin-top:14px;display:flex;flex-direction:column;gap:12px;">
        {% for r in req_rows %}
          <div class="row">
            <div style="flex:1;">
              <div class="row-title">{{ r.staff_name }} {{ r.staff_surname }}</div>
              <div class="row-sub">
                {{ r.request_type }} ‚Ä¢ {{ r.request_date }} ‚Ä¢ Status: {{ r.status }}
              </div>

              <div class="row-sub" style="margin-top:6px;">
                {% if r.start_date %}From {{ r.start_date }}{% endif %}
                {% if r.end_date %} to {{ r.end_date }}{% endif %}
                {% if r.start_time %} ‚Ä¢ {{ r.start_time }}{% endif %}
                {% if r.end_time %} - {{ r.end_time }}{% endif %}
                {% if r.extra_time %} ‚Ä¢ Extra: {{ r.extra_time }} mins{% endif %}
              </div>

              {% if r.reason %}
                <div class="page-sub" style="margin-top:8px;">‚Äú{{ r.reason }}‚Äù</div>
              {% endif %}
            </div>

            <div style="display:flex;gap:10px;align-items:center;">
              {% if r.status == 'PENDING' %}
                <form method="post" action="{{ url_for('update_staff_request_status') }}">
                  <input type="hidden" name="request_id" value="{{ r.request_id }}">
                  <input type="hidden" name="status" value="APPROVED">
                  <button class="btn dark" type="submit">Approve</button>
                </form>

                <form method="post" action="{{ url_for('update_staff_request_status') }}">
                  <input type="hidden" name="request_id" value="{{ r.request_id }}">
                  <input type="hidden" name="status" value="REJECTED">
                  <button class="btn gray" type="submit">Reject</button>
                </form>
              {% else %}
                <span class="badge gray">{{ r.status }}</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Delete Staff Confirmation Modal -->
  <div class="modal-backdrop" id="deleteStaffModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">‚ö†Ô∏è Delete Staff Member</div>
          <div class="modal-sub">This action cannot be undone</div>
        </div>
        <button class="close" onclick="closeModal('deleteStaffModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:16px;margin-bottom:16px;">
          <div style="font-weight:700;color:#991b1b;margin-bottom:8px;">‚ö†Ô∏è Important</div>
          <div style="color:#7f1d1d;font-size:14px;">
            You can only delete staff member "<span id="deleteStaffName" style="font-weight:700;"></span>" if they have:
            <ul style="margin:8px 0 0 20px;">
              <li><strong>No orders assigned</strong></li>
              <li><strong>No schedules</strong></li>
              <li><strong>No payroll records</strong></li>
            </ul>
            <div style="margin-top:12px;">
              If the staff member has any of these records, you cannot delete them. Consider deactivating their account instead.
            </div>
            <div style="margin-top:8px;font-size:13px;color:#6b7280;">
              Note: This will also remove their pending requests.
            </div>
          </div>
        </div>

        <form method="post" id="deleteStaffForm">
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button type="button" class="btn gray" onclick="closeModal('deleteStaffModal')">Cancel</button>
            <button type="submit" class="btn" style="background:#dc2626;color:white;">Delete Staff Member</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function confirmDeleteStaff(staffId, staffName) {
      document.getElementById('deleteStaffName').textContent = staffName;
      document.getElementById('deleteStaffForm').action = `/staff-management/delete/${staffId}`;
      openModal('deleteStaffModal');
    }
  </script>
{% endblock %}
