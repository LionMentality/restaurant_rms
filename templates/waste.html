{% extends "base.html" %}
{% block content %}
  <h1 class="page-title">Waste Management</h1>
  <p class="page-sub">Track and analyze food waste and expired inventory</p>

  <div class="grid cols-3">
    <div class="card kpi">
      <div class="label">Total Waste Items</div>
      <div class="value">{{ total_waste_items }}</div>
      <div class="hint">Distinct ingredients wasted</div>
    </div>

    <div class="card kpi">
      <div class="label">Estimated Cost Loss</div>
      <div class="value red">${{ "%.2f"|format(total_waste_cost) }}</div>
      <div class="hint">Total value of wasted items</div>
    </div>

    <div class="card kpi">
      <div class="label">Most Common Reason</div>
      <div class="value">{{ most_common_reason }}</div>
      <div class="hint">Primary waste cause</div>
    </div>
  </div>

  {% if session.get("role") == "manager" %}
  <div style="display:flex;gap:12px;margin:18px 0;">
    <button class="btn dark" onclick="openModal('recordWasteModal')">üìù Record Waste</button>
    <a href="{{ url_for('waste_weekly_report') }}" class="btn dark">üìä Weekly Report</a>
  </div>
  {% endif %}

  <div class="card pad" style="margin-top:16px;">
    <div style="font-weight:900;font-size:18px;">Waste Entries</div>
    <div class="page-sub">Most recent first</div>

    {% if rows|length == 0 %}
      <div class="card pad" style="margin-top:14px;">
        <b>No waste entries yet.</b>
        <div class="page-sub" style="margin-top:6px;">Add rows to waste_tracking to see this page.</div>
      </div>
    {% else %}
      <div style="margin-top:14px;display:flex;flex-direction:column;gap:12px;">
        {% for r in rows %}
          <div class="row">
            <div style="flex:1;">
              <div class="row-title">{{ r.ingredient_name }}</div>
              <div class="row-sub">
                {{ r.waste_date }} ‚Ä¢ Qty: {{ r.amount_wasted }} ‚Ä¢ Reason: {{ r.reason or "‚Äî" }}
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:900;color:#ef4444;">
                ${{ "%.2f"|format(r.waste_cost) }}
              </div>
              <div class="row-sub">
                Unit: ${{ "%.2f"|format(r.average_unit_cost) }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Record Waste Modal -->
  <div class="modal-backdrop" id="recordWasteModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">Record Waste</div>
          <div class="modal-sub">Log wasted ingredients</div>
        </div>
        <button class="close" onclick="closeModal('recordWasteModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('record_waste') }}">
          <div style="margin-bottom:12px;">
            <label>Ingredient</label>
            <select name="ingredient_id" class="select" style="width:100%;" required>
              <option value="">Select ingredient...</option>
              {% for r in rows %}
              <option value="{{ r.ingredient_id }}">{{ r.ingredient_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div style="margin-bottom:12px;">
            <label>Amount Wasted</label>
            <input type="number" name="amount_wasted" step="0.01" min="0.01" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>

          <div style="margin-bottom:12px;">
            <label>Reason</label>
            <select name="reason" class="select" style="width:100%;margin-bottom:8px;">
              <option value="Expired">Expired</option>
              <option value="Damaged">Damaged</option>
              <option value="Overproduction">Overproduction</option>
              <option value="Spoiled">Spoiled</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn gray" onclick="closeModal('recordWasteModal')">Cancel</button>
            <button type="submit" class="btn dark">Record Waste</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
