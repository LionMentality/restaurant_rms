{% extends "base.html" %}
{% block content %}
<div style="max-width:1400px;">
  <h1 class="page-title">Table Management</h1>
  <p class="page-sub">Monitor and manage restaurant tables and orders</p>

  <div style="display:flex;gap:12px;margin:18px 0;">
    <a href="{{ url_for('search_orders') }}" class="btn dark">üîç Search Orders</a>
  </div>

  <!-- KPIs -->
  <div class="grid cols-3" style="margin-bottom:24px;">
    <div class="card kpi">
      <div class="label">Occupied Tables</div>
      <div class="value">{{ occupied_tables }}/{{ total_tables }}</div>
      <div class="hint">{{ total_tables - occupied_tables }} tables available</div>
    </div>

    <div class="card kpi">
      <div class="label">Active Orders</div>
      <div class="value">{{ active_orders }}</div>
      <div class="hint">Across all tables</div>
    </div>

    <div class="card kpi">
      <div class="label">Current Revenue</div>
      <div class="value" style="color:#16a34a;">
        ${{ "%.2f"|format(current_revenue) }}
      </div>
      <div class="hint">From active tables</div>
    </div>
  </div>

  <!-- Tables List -->
  <div style="display:flex;flex-direction:column;gap:16px;">
    {% for t in tables %}
      <div
        class="card table-card-full"
        style="padding:20px;transition:all 0.2s;"
      >
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <!-- Left: Table info -->
          <div>
            <div style="font-weight:900;font-size:20px;margin-bottom:4px;">
              Table {{ t.table_number }}
            </div>
            <div class="page-sub" style="margin:0;">
              Capacity: {{ t.capacity }}
            </div>
          </div>

          <!-- Right: Status badge -->
          <div>
            {% if t.status == 'OCCUPIED' %}
              <span class="badge" style="background:#dbeafe;color:#1d4ed8;border:1px solid #93c5fd;">Occupied</span>
            {% elif t.status == 'AVAILABLE' %}
              <span class="badge" style="background:#dcfce7;color:#166534;border:1px solid #86efac;">Available</span>
            {% elif t.status == 'RESERVED' %}
              <span class="badge" style="background:#fef9c3;color:#854d0e;border:1px solid #fde047;">Reserved</span>
            {% else %}
              <span class="badge" style="background:#f3f4f6;color:#374151;border:1px solid #d1d5db;">Closed</span>
            {% endif %}
          </div>
        </div>

        <!-- Metrics row -->
        <div style="display:flex;gap:80px;margin-top:20px;">
          <div>
            <div class="page-sub" style="margin:0 0 6px;">Occupancy:</div>
            <div style="font-weight:800;font-size:18px;">
              {{ t.occupancy }}/{{ t.capacity }}
            </div>
          </div>

          <div>
            <div class="page-sub" style="margin:0 0 6px;">Parties:</div>
            <div style="font-weight:800;font-size:18px;">
              {{ t.parties }}
            </div>
          </div>

          <div>
            <div class="page-sub" style="margin:0 0 6px;">Total Bill:</div>
            <div style="font-weight:900;font-size:18px;color:#16a34a;">
              ${{ "%.2f"|format(t.total_bill) }}
            </div>
          </div>
        </div>

        <!-- Action buttons -->
        <div style="margin-top:18px;padding-top:18px;border-top:1px solid #e5e7eb;display:flex;gap:8px;">
          {% if t.status == 'AVAILABLE' or t.status == 'RESERVED' %}
            <button class="btn dark" style="font-size:13px;padding:8px 16px;" onclick="event.stopPropagation();openNewOrderModal({{ t.table_id }}, {{ t.table_number }})">
              üçΩÔ∏è New Order
            </button>
          {% endif %}
          <button class="btn gray" style="font-size:13px;padding:8px 16px;" onclick="event.stopPropagation();openTableDetails({{ t.table_id }})">
            View Details
          </button>
          {% if session.get("role") == "manager" %}
            <button class="btn gray" style="font-size:13px;padding:8px 16px;" onclick="event.stopPropagation();openStatusModal({{ t.table_id }}, {{ t.table_number }}, '{{ t.status }}')">
              Change Status
            </button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- New Order Modal -->
<div class="modal-backdrop" id="newOrderModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Create New Order</div>
        <div class="modal-sub" id="newOrderSubtitle">For Table -</div>
      </div>
      <button class="close" onclick="closeModal('newOrderModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('create_order') }}">
        <input type="hidden" name="table_id" id="newOrderTableId">

        <div style="margin-bottom:12px;">
          <label>Special Requests (optional)</label>
          <textarea name="special_requests" rows="2" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" placeholder="Any special instructions..."></textarea>
        </div>

        <div style="margin-bottom:12px;">
          <label>Select Menu Items</label>
          <div style="max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:10px;padding:10px;">
            {% for item in menu_items %}
            {% if item.is_available %}
            <div style="margin-bottom:12px;padding:10px;background:#f9fafb;border-radius:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <label style="display:flex;align-items:center;gap:8px;flex:1;">
                  <input type="checkbox" name="menu_items" value="{{ item.menu_item_id }}" onchange="toggleQuantity({{ item.menu_item_id }})">
                  <div>
                    <div style="font-weight:700;">{{ item.name }}</div>
                    <div style="font-size:12px;color:var(--muted);">{{ item.category }}</div>
                  </div>
                </label>
                <div style="font-weight:800;color:var(--accent);">${{ "%.2f"|format(item.menu_price) }}</div>
              </div>
              <input
                type="number"
                name="quantity_{{ item.menu_item_id }}"
                id="qty_{{ item.menu_item_id }}"
                min="1"
                value="1"
                disabled
                style="width:100px;padding:6px;border:1px solid #e5e7eb;border-radius:6px;margin-left:24px;"
                placeholder="Qty">
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <button type="button" class="btn gray" onclick="closeModal('newOrderModal')">Cancel</button>
          <button type="submit" class="btn dark">Create Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Status Modal -->
<div class="modal-backdrop" id="statusModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Change Table Status</div>
        <div class="modal-sub" id="statusSubtitle">Update status for Table -</div>
      </div>
      <button class="close" onclick="closeModal('statusModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('update_table_status') }}">
        <input type="hidden" name="table_id" id="statusTableId">

        <div style="margin-bottom:12px;">
          <label>New Status</label>
          <select name="status" id="statusSelect" class="select" style="width:100%;" required>
            <option value="AVAILABLE">Available</option>
            <option value="OCCUPIED">Occupied</option>
            <option value="RESERVED">Reserved</option>
            <option value="CLOSED">Closed</option>
          </select>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <button type="button" class="btn gray" onclick="closeModal('statusModal')">Cancel</button>
          <button type="submit" class="btn dark">Update Status</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal -->
<dialog id="tableDetailsModal" style="border:none;border-radius:18px;max-width:600px;width:92vw;padding:0;">
  <div style="padding:24px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
      <div>
        <div id="tdTitle" style="font-weight:900;font-size:24px;">Table - Details</div>
        <div id="tdSubtitle" class="page-sub" style="margin:6px 0 0;">View all parties and orders for this table</div>
      </div>
      <button 
        onclick="document.getElementById('tableDetailsModal').close()"
        style="width:40px;height:40px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:18px;"
      >
        ‚úï
      </button>
    </div>

    <div id="tdBody" style="margin-top:20px;">
      <div class="page-sub">Loading‚Ä¶</div>
    </div>
  </div>
</dialog>

<script>
function openNewOrderModal(tableId, tableNumber) {
  document.getElementById('newOrderTableId').value = tableId;
  document.getElementById('newOrderSubtitle').textContent = `For Table ${tableNumber}`;
  openModal('newOrderModal');
}

function openStatusModal(tableId, tableNumber, currentStatus) {
  document.getElementById('statusTableId').value = tableId;
  document.getElementById('statusSubtitle').textContent = `Update status for Table ${tableNumber}`;
  document.getElementById('statusSelect').value = currentStatus;
  openModal('statusModal');
}

function toggleQuantity(itemId) {
  const checkbox = document.querySelector(`input[name="menu_items"][value="${itemId}"]`);
  const qtyInput = document.getElementById(`qty_${itemId}`);
  qtyInput.disabled = !checkbox.checked;
  if (!checkbox.checked) {
    qtyInput.value = 1;
  }
}

async function openTableDetails(tableId) {
  const modal = document.getElementById("tableDetailsModal");
  const body = document.getElementById("tdBody");
  const title = document.getElementById("tdTitle");

  title.textContent = `Table ${tableId} - Details`;
  body.innerHTML = `<div class="page-sub">Loading‚Ä¶</div>`;
  modal.showModal();

  try {
    const res = await fetch(`/tables/${tableId}/details`);
    if (!res.ok) throw new Error("Failed to load details");
    const data = await res.json();

    title.textContent = `Table ${data.table_number} - Details`;

    // Items list
    const itemsHtml = (data.items || []).length > 0
      ? data.items.map(it => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f3f4f6;">
            <div style="display:flex;gap:12px;align-items:center;">
              <span style="font-weight:800;min-width:30px;">${it.qty}x</span>
              <div style="font-weight:600;">${it.name}</div>
            </div>
            <div style="font-weight:800;">$${Number(it.price_total).toFixed(2)}</div>
          </div>
        `).join("")
      : `<div class="page-sub" style="padding:20px 0;text-align:center;">No items.</div>`;

    body.innerHTML = `
      <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:14px;padding:18px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
          <div style="font-weight:900;font-size:18px;">Party 1</div>
          <span class="badge" style="background:#ede9fe;color:#6d28d9;border:1px solid #d8b4fe;">
            ${data.party?.status || "‚Äî"}
          </span>
        </div>

        <div class="page-sub" style="margin:0 0 16px;">
          ${data.party?.guests || 0} guests ‚Ä¢ Seated at ${data.party?.seated_at || "‚Äî"}
        </div>

        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-bottom:18px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:36px;height:36px;border-radius:50%;background:#f3f4f6;display:grid;place-items:center;font-weight:800;">
              üë§
            </div>
            <div>
              <div style="font-weight:800;">${data.party?.server_name || "‚Äî"}</div>
              <div class="page-sub" style="margin:2px 0 0;">Server ID: ${data.party?.server_code || "‚Äî"}</div>
            </div>
          </div>
        </div>

        <div style="font-weight:900;font-size:16px;margin-bottom:8px;">Order Items</div>
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:0 14px;">
          ${itemsHtml}
        </div>

        <div style="margin-top:18px;padding-top:18px;border-top:2px solid #e5e7eb;">
          <div style="display:flex;justify-content:space-between;margin:8px 0;">
            <div class="page-sub">Subtotal:</div>
            <div style="font-weight:800;">$${Number(data.subtotal || 0).toFixed(2)}</div>
          </div>
          <div style="display:flex;justify-content:space-between;margin:8px 0;">
            <div class="page-sub">Tax:</div>
            <div style="font-weight:800;">$${Number(data.tax || 0).toFixed(2)}</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:14px;border-top:1px solid #e5e7eb;">
            <div style="font-weight:900;font-size:18px;">Total:</div>
            <div style="font-weight:900;font-size:22px;color:#16a34a;">
              $${Number(data.total || 0).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
    `;
  } catch (e) {
    body.innerHTML = `<div class="page-sub">Error loading details.</div>`;
  }
}
</script>
{% endblock %}