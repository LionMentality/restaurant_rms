{% extends "base.html" %}
{% block content %}
  <h1 class="page-title">Inventory Management</h1>
  <p class="page-sub">Track and manage restaurant inventory items</p>

  <div class="grid cols-3">
    <div class="card kpi">
      <div class="label">Total Items</div>
      <div class="value">{{ total_items }}</div>
      <div class="hint">Across all ingredients</div>
    </div>

    <div class="card kpi">
      <div class="label">Low Stock Items</div>
      <div class="value red">{{ low_stock_items }}</div>
      <div class="hint">Below minimum threshold</div>
    </div>

    <div class="card kpi">
      <div class="label">Expiring Soon</div>
      <div class="value orange">{{ expiring_soon }}</div>
      <div class="hint">Within the next 7 days</div>
    </div>
  </div>

  {% if session.get("role") == "manager" %}
  <div style="display:flex;gap:12px;margin:18px 0;">
    <button class="btn dark" onclick="openModal('receiveShipmentModal')">üì¶ Receive Shipment</button>
    <button class="btn dark" onclick="openModal('adjustStockModal')">‚öñÔ∏è Adjust Stock</button>
    <a href="{{ url_for('inventory_weekly_report') }}" class="btn dark">üìä Weekly Report</a>
  </div>
  {% endif %}

  <form class="search-row" method="get" action="{{ url_for('inventory_page') }}">
    <div class="input" style="flex:1;">
      <span class="icon">üîç</span>
      <input name="q" value="{{ q }}" placeholder="Search inventory items...">
    </div>
  </form>

  {% if items|length == 0 %}
    <div class="card pad" style="margin-top:14px;">
      <b>No inventory items found.</b>
      <div class="page-sub" style="margin-top:6px;">
        Either your inventory is empty or your search returned no results.
      </div>
    </div>
  {% endif %}

  {% for it in items %}
    <div class="card pad" style="margin-top:12px;">
      <div class="row" style="border:none;padding:0;">
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="row-title">{{ it.ingredient_name }}</div>
            {% if session.get("role") == "manager" %}
            <button
              class="btn gray"
              style="padding:4px 10px;font-size:12px;"
              onclick="confirmDelete({{ it.ingredient_id }}, '{{ it.ingredient_name }}')">
              üóëÔ∏è Delete
            </button>
            {% endif %}
          </div>
          <div class="row-sub">{{ it.unit }}</div>

          <div style="display:flex;gap:40px;margin-top:14px;color:var(--muted);flex-wrap:wrap;">
            <div>
              <div>Current Quantity</div>
              <div style="color:var(--text);font-weight:800;margin-top:6px;">
                {{ it.current_quantity }} {{ it.unit }}
              </div>
            </div>

            <div>
              <div>Min. Quantity
                {% if session.get("role") == "manager" %}
                <button class="btn gray" style="padding:4px 8px;font-size:11px;margin-left:6px;" onclick="editThreshold({{ it.ingredient_id }}, {{ it.minimum_stock_threshold }}, '{{ it.ingredient_name }}')">Edit</button>
                {% endif %}
              </div>
              <div style="color:var(--text);font-weight:800;margin-top:6px;">
                {{ it.minimum_stock_threshold }} {{ it.unit }}
              </div>
            </div>

            <div>
              <div>Last Updated</div>
              <div style="color:var(--text);font-weight:800;margin-top:6px;">
                {{ it.last_update_date }}
              </div>
            </div>

            <div>
              <div>Expiration Date</div>
              <div style="color:var(--text);font-weight:800;margin-top:6px;">
                {{ it.expiration_date or "‚Äî" }}
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          {% if it.is_low_stock %}<span class="badge orange">Low Stock</span>{% else %}<span class="badge gray">In Stock</span>{% endif %}
          {% if it.is_expired %}<span class="badge red">Expired</span>{% endif %}
          {% if (not it.is_expired) and it.is_expiring_soon %}<span class="badge yellow">Expiring Soon</span>{% endif %}
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- Receive Shipment Modal -->
  <div class="modal-backdrop" id="receiveShipmentModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">Receive Shipment</div>
          <div class="modal-sub">Log received ingredients and update inventory</div>
        </div>
        <button class="close" onclick="closeModal('receiveShipmentModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('receive_shipment') }}">
          <div style="margin-bottom:12px;">
            <label>Ingredient</label>
            <select name="ingredient_id" class="select" style="width:100%;" required>
              <option value="">Select ingredient...</option>
              {% for it in items %}
              <option value="{{ it.ingredient_id }}">{{ it.ingredient_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div style="margin-bottom:12px;">
            <label>Quantity Received</label>
            <input type="number" name="quantity" step="0.01" min="0.01" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>

          <div style="margin-bottom:12px;">
            <label>Unit Cost</label>
            <input type="number" name="unit_cost" step="0.01" min="0.01" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>

          <div style="margin-bottom:12px;">
            <label>Expiration Date (Optional)</label>
            <input type="date" name="expiration_date" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn gray" onclick="closeModal('receiveShipmentModal')">Cancel</button>
            <button type="submit" class="btn dark">Receive Shipment</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Adjust Stock Modal -->
  <div class="modal-backdrop" id="adjustStockModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">Adjust Stock</div>
          <div class="modal-sub">Manual inventory adjustment</div>
        </div>
        <button class="close" onclick="closeModal('adjustStockModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('adjust_inventory') }}">
          <div style="margin-bottom:12px;">
            <label>Ingredient</label>
            <select name="ingredient_id" class="select" style="width:100%;" required>
              <option value="">Select ingredient...</option>
              {% for it in items %}
              <option value="{{ it.ingredient_id }}">{{ it.ingredient_name }} (Current: {{ it.current_quantity }})</option>
              {% endfor %}
            </select>
          </div>

          <div style="margin-bottom:12px;">
            <label>Adjustment Amount (+ to add, - to subtract)</label>
            <input type="number" name="adjustment" step="0.01" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" placeholder="e.g., +5.5 or -2.3">
          </div>

          <div style="margin-bottom:12px;">
            <label>Reason</label>
            <textarea name="reason" rows="3" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" placeholder="Reason for adjustment..."></textarea>
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn gray" onclick="closeModal('adjustStockModal')">Cancel</button>
            <button type="submit" class="btn dark">Adjust Stock</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Threshold Modal -->
  <div class="modal-backdrop" id="editThresholdModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">Edit Minimum Threshold</div>
          <div class="modal-sub" id="thresholdIngredientName"></div>
        </div>
        <button class="close" onclick="closeModal('editThresholdModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('update_threshold') }}">
          <input type="hidden" name="ingredient_id" id="thresholdIngredientId">

          <div style="margin-bottom:12px;">
            <label>Minimum Stock Threshold</label>
            <input type="number" name="threshold" id="thresholdValue" step="0.01" min="0" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn gray" onclick="closeModal('editThresholdModal')">Cancel</button>
            <button type="submit" class="btn dark">Update Threshold</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-backdrop" id="deleteIngredientModal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">‚ö†Ô∏è Delete Ingredient</div>
          <div class="modal-sub">This action cannot be undone</div>
        </div>
        <button class="close" onclick="closeModal('deleteIngredientModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:16px;margin-bottom:16px;">
          <div style="font-weight:700;color:#991b1b;margin-bottom:8px;">‚ö†Ô∏è Important</div>
          <div style="color:#7f1d1d;font-size:14px;">
            You can only delete ingredient "<span id="deleteIngredientName" style="font-weight:700;"></span>" if:
            <ul style="margin:8px 0 0 20px;">
              <li><strong>It is NOT used in any menu items</strong></li>
            </ul>
            <div style="margin-top:12px;">
              If the ingredient is used in menu items, you must remove it from those menu items first.
            </div>
            <div style="margin-top:8px;font-size:13px;color:#6b7280;">
              Note: This will also remove inventory records and waste tracking history for this ingredient.
            </div>
          </div>
        </div>

        <form method="post" id="deleteIngredientForm">
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button type="button" class="btn gray" onclick="closeModal('deleteIngredientModal')">Cancel</button>
            <button type="submit" class="btn" style="background:#dc2626;color:white;">Delete Ingredient</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function editThreshold(ingredientId, currentThreshold, ingredientName) {
      document.getElementById('thresholdIngredientId').value = ingredientId;
      document.getElementById('thresholdValue').value = currentThreshold;
      document.getElementById('thresholdIngredientName').textContent = ingredientName;
      openModal('editThresholdModal');
    }

    function confirmDelete(ingredientId, ingredientName) {
      document.getElementById('deleteIngredientName').textContent = ingredientName;
      document.getElementById('deleteIngredientForm').action = `/inventory/delete/${ingredientId}`;
      openModal('deleteIngredientModal');
    }
  </script>
{% endblock %}
